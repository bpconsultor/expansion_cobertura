<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <!-- Bootstrap CSS -->
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        
        
        <style>
      /* General page styling */
      body, html {
        height: 100%;
        margin: 0;
        display: flex;
        flex-direction: column;
    }

    /* Container for the scrollable content */
    .content-container {
        flex: 1; /* Take up all available space */
        display: flex;
        flex-direction: column;
        overflow-y: auto; /* Enable scrolling */
    }

    /* Map and filter/table sections */
    .map-container {
        height: 550px;
        background-color: #e5e5e5; /* Placeholder for map */
        margin-bottom: 20px;
    }

    .table-container {
        max-height: 350px; /* Set table height */
        overflow-y: auto;  /* Enable scrolling within table */
    }

            /* Header styling */
            .header {
                background-color: #343a40;
                color: white;
                padding: 10px 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
    
            .header img {
                height: 50px; /* Adjust logo size */
                margin-right: 10px;
            }
    
            .header h1 {
                margin: 0;
                font-size: 24px;
            }

    /* Footer styling */
    footer {
        height: 50px;
        background-color: #343a40;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .content-container {
        flex: 1; /* Take up all available space */
        display: flex;
        flex-direction: column;
        overflow-y: auto; /* Enable scrolling */
        padding-left: 20px; /* Add padding to the left */
        padding-bottom: 20px;
    }
    
    /* Optional: You can also apply padding to the individual sections if needed */
    .map-container, .table-container, .container {
        padding-left: 20px; /* Add left padding to map, filter, and table */
    }

    .pagination-container {
        margin-top: 20px; /* Add spacing between the table and pagination */
        padding-top: 10px; /* Optional padding inside the pagination container */
    }

        </style>
        
        
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet-measure.css">
        <style>
            #map {
                width: 100%;
                height: 550px;
            }
            #filter-column {
                height: 550px;
                overflow-y: auto;
            }
            #table-section {
                margin-top: 20px;
            }
        </style>
        <title> Expansión Ciclo Básico</title>
    </head>
    <body>

              <!-- Header with two logos -->
              <header class="header">
                <!-- Left side: Logos -->
                <div class="d-flex align-items-center">
                    <img src="path/to/logo1.png" alt="Logo 1">
                    <img src="path/to/logo2.png" alt="Logo 2">
                </div>
        
                <!-- Center: Title -->
                <h1 class="text-center">Escuelas candidatas para la expansión del Ciclo Básico</h1>
        
                <!-- Right side: Navigation link -->
                <div>
                    <a href="diver.html" class="btn btn-outline-light">Análisis Diversificado</a>
                </div>
            </header>

            <!-- Main content with filters and map -->
            <div class="content-container">
                <div class="row">
                    <!-- Filters Column -->
                    <div class="col-md-3 bg-light" id="filter-column">
                        <!-- Departamento and Municipio Dropdowns -->
                        <div class="form-group mt-4">
                            <label for="departamenSelect">Departamento</label>
                            <select id="departamenSelect" class="form-control">
                                <option value="">Seleccione un Departamento</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="municipioSelect">Municipio</label>
                            <select id="municipioSelect" class="form-control" disabled>
                                <option value="">Seleccione un Municipio</option>
                            </select>
                        </div>
                        <button id="zoomToMunicipio" class="btn btn-secondary btn-block" disabled>Zoom al Municipio</button>

                        <div class="container mt-4">
                            <div class="row">
                                <div class="col-md-12">
                                    <h6>Zoom al Clúster</h6>
                                    <div class="input-group mb-3">
                                        <input type="number" class="form-control" id="clusterInput" placeholder="Ingrese número de Clúster">
                                        <div class="input-group-append">
                                            <button class="btn btn-outline-secondary" type="button" id="zoomToClusterBtn">Zoom al Clúster</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    
                        <!-- Radio Button to toggle Filter Section -->
                        <div class="form-group mt-4">
                            <label>Mostrar controles avanzados</label>
                            <div>
                                <input type="radio" id="hideFilters" name="filterToggle" value="hide" checked> No
                                <input type="radio" id="showFilters" name="filterToggle" value="show"> Sí
                            </div>
                        </div>
                        
                    
                        <!-- Filter Section (Initially Hidden) -->
                        <div id="advancedFilters" style="display: none;">

                            <div class="form-group">
                                <label for="demandaMinima">Establezca Demanda Mínima</label>
                                <input type="number" class="form-control" id="demandaMinima" placeholder="Ingrese Demanda Mínima" step="any" min="0" value="40">
                            </div>


                            <h6 class="my-3">Cambie pesos para establecer prioridades</h6>
                            <form id="priority-form">
                                <div class="row">
                                    <div class="col-6">
                                        <div class="form-group">
                                            <label for="demanda">Demanda</label>
                                            <input type="number" class="form-control" id="demanda" placeholder="Demanda" step="any" min="0" max="1" >
                                        </div>
                                        <div class="form-group">
                                            <label for="pobreza">Pobreza</label>
                                            <input type="number" class="form-control" id="pobreza" placeholder="Pobreza" step="any" min="0" max="1" >
                                        </div>
                                        <div class="form-group">
                                            <label for="discapacidad">Discapacidad</label>
                                            <input type="number" class="form-control" id="discapacidad" placeholder="Discapacidad" step="any" min="0" max="1">
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-group">
                                            <label for="etnicidad">Etnicidad</label>
                                            <input type="number" class="form-control" id="etnicidad" placeholder="Etnicidad" step="any" min="0" max="1" >
                                        </div>
                                        <div class="form-group">
                                            <label for="migracion">Migración</label>
                                            <input type="number" class="form-control" id="migracion" placeholder="Migración" step="any" min="0" max="1" >
                                        </div>
                                        <div class="form-group">
                                            <label for="embarazos">Embarazos</label>
                                            <input type="number" class="form-control" id="embarazos" placeholder="Embarazos" step="any" min="0" max="1" >
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary btn-block">Aplicar</button>
                            </form>
                        </div>
                    
                        <div class="form-row mt-3">
                            <div class="col">
                        <button type="button" id="zoom-out-button" class="btn btn-secondary mt-3">Zoom Out</button>
                    </div>
                    <div class="col">
                        <!-- Button to download as Excel -->
                        <button id="downloadExcel" class="btn btn-secondary mt-3">Descargue a Excel</button>
                    </div>
                </div>
                    </div>
    
                    <!-- Map Section -->
                    <div class="col-md-9">
                        <div id="map"></div>
                    </div>
                </div>

            <!-- Tabular data section below map and filters -->
            <div class="row" id="table-section">
                <div class="col-md-12">
                    <div class="table-container">
                    <h6>Tabla de datos</h6>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Clúster</th>
                                <th>Departamento</th>
                                <th>Municipio</th>
                                <th>Número escuelas</th>
                                <th>Escuela 1</th>
                                <th>Escuela 2</th>
                                <th>Escuela 3</th>
                                <th>Escuela 4</th>
                                <th>Escuela 5</th>
                                <th>Escuela 6</th>
                                <th>Escuela 7</th>
                                <th>Escuela 8</th>
                                <th>Demanda</th>
                                <th>Área</th>
                                <th>Proporción electricidad</th>
                                <th>Municipio Prioritario</th>
                                <th>Índice</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Rows will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="container">
                    <div class="pagination-container d-flex justify-content-between mb-3">
                        <button id="prevPage" class="btn btn-secondary" disabled>Anterior</button>
                        <button id="nextPage" class="btn btn-secondary">Siguiente</button>
                    </div>
                </div>
                </div>
            </div>

      <!-- Footer -->
      <footer>
        <p></p>
    </footer>

        </div>
       
 
       
       
       
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet-measure.js"></script>
        <script src="data/Municipios_1.js"></script>
        <script src="data/PoligonosBasico_2.js"></script>
        <script src="data/Escuelascandidatasprimaria_3.js"></script>
        <script>
        //console.log("JavaScript is loaded!");

        // Overlay layers (TMS)
        var lyr = L.tileLayer('./{z}/{x}/{y}.png', {
            tms: 1,
            opacity: 0.8, // Set transparency for custom tiles
            attribution: "",
            minZoom: 6,
            maxZoom: 22,
            zIndex: 600 // Ensure it's above OSM
        });
        
        var map = L.map('map', {
            zoomControl: true, 
            maxZoom: 22, 
            minZoom: 1,
            zIndex: 200
        }).fitBounds([[13.68180002055987,-93.39339285963621],[17.964739444007968,-86.88766208984163]]);
        map.addLayer(lyr);

        var layersLoaded = false;
function loadLayers() {
    if (!layersLoaded) {
        map.addLayer(layer_PoligonosBasico_2);
        map.addLayer(layer_Escuelascandidatasprimaria_3);
        map.addLayer(layer_Municipios_1);
        layersLoaded = true;
    }
}

map.on('zoomend', function() {
    if (map.getZoom() >= 11 && !layersLoaded) {
        loadLayers();
    }
});
            
        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});
        // remove popup's row if "visible-with-data"
        function removeEmptyRowsFromPopupContent(content, feature) {
         var tempDiv = document.createElement('div');
         tempDiv.innerHTML = content;
         var rows = tempDiv.querySelectorAll('tr');
         for (var i = 0; i < rows.length; i++) {
             var td = rows[i].querySelector('td.visible-with-data');
             var key = td ? td.id : '';
             if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                 rows[i].parentNode.removeChild(rows[i]);
             }
         }
         return tempDiv.innerHTML;
        }
        // add class to format popup if it contains media
		function addClassToPopupIfMedia(content, popup) {
			var tempDiv = document.createElement('div');
			tempDiv.innerHTML = content;
			if (tempDiv.querySelector('td img')) {
				popup._contentNode.classList.add('media');
					// Delay to force the redraw
					setTimeout(function() {
						popup.update();
					}, 10);
			} else {
				popup._contentNode.classList.remove('media');
			}
		}
        var zoomControl = L.control.zoom({
            position: 'topleft'
        }).addTo(map);
        var measureControl = new L.Control.Measure({
            position: 'topleft',
            primaryLengthUnit: 'feet',
            secondaryLengthUnit: 'miles',
            primaryAreaUnit: 'sqfeet',
            secondaryAreaUnit: 'sqmiles'
        });
        measureControl.addTo(map);
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].innerHTML = '';
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].className += ' fas fa-ruler';
        var bounds_group = new L.featureGroup([]);
        function setBounds() {
            map.setMaxBounds(map.getBounds());
        }
        map.createPane('pane_OpenStreetMap_0');
        map.getPane('pane_OpenStreetMap_0').style.zIndex = 400;
        //var layer_OpenStreetMap_0 = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        //    pane: 'pane_OpenStreetMap_0',
        //    opacity: 1.0,
        //    attribution: '',
        //    minZoom: 1,
        //    maxZoom: 22,
        //    minNativeZoom: 0,
        //    maxNativeZoom: 19,
        //    zIndex: 10
        //});
        //layer_OpenStreetMap_0;
        //map.addLayer(layer_OpenStreetMap_0);
        function pop_Municipios_1(feature, layer) {
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['id'] !== null ? autolinker.link(feature.properties['id'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['objectid'] !== null ? autolinker.link(feature.properties['objectid'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['municipio'] !== null ? autolinker.link(feature.properties['municipio'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['cod_dep'] !== null ? autolinker.link(feature.properties['cod_dep'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['departamen'] !== null ? autolinker.link(feature.properties['departamen'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['codigo_mun'] !== null ? autolinker.link(feature.properties['codigo_mun'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['shape_leng'] !== null ? autolinker.link(feature.properties['shape_leng'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['shape_area'] !== null ? autolinker.link(feature.properties['shape_area'].toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Municipios_1_0() {
            return {
                pane: 'pane_Municipios_1',
                opacity: 1,
                color: 'rgba(15,28,39,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 1.0,
                fillOpacity: 0,
                interactive: false,
            }
        }
        map.createPane('pane_Municipios_1');
        map.getPane('pane_Municipios_1').style.zIndex = 401;
        map.getPane('pane_Municipios_1').style['mix-blend-mode'] = 'normal';
        var layer_Municipios_1 = new L.geoJson(json_Municipios_1, {
            attribution: '',
            interactive: false,
            dataVar: 'json_Municipios_1',
            layerName: 'layer_Municipios_1',
            pane: 'pane_Municipios_1',
            onEachFeature: pop_Municipios_1,
            style: style_Municipios_1_0,
        });
        bounds_group.addLayer(layer_Municipios_1);
        function pop_PoligonosBasico_2(feature, layer) {
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Status_Ass'] !== null ? autolinker.link(feature.properties['Status_Ass'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['ORIG_FID'] !== null ? autolinker.link(feature.properties['ORIG_FID'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Shape_Leng'] !== null ? autolinker.link(feature.properties['Shape_Leng'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Shape_Area'] !== null ? autolinker.link(feature.properties['Shape_Area'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['school1'] !== null ? autolinker.link(feature.properties['school1'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['school2'] !== null ? autolinker.link(feature.properties['school2'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['school3'] !== null ? autolinker.link(feature.properties['school3'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['school4'] !== null ? autolinker.link(feature.properties['school4'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['school5'] !== null ? autolinker.link(feature.properties['school5'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['school6'] !== null ? autolinker.link(feature.properties['school6'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['school7'] !== null ? autolinker.link(feature.properties['school7'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['school8'] !== null ? autolinker.link(feature.properties['school8'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['OBJECTID_1'] !== null ? autolinker.link(feature.properties['OBJECTID_1'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Departamen'] !== null ? autolinker.link(feature.properties['Departamen'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Municipio'] !== null ? autolinker.link(feature.properties['Municipio'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['CodMun'] !== null ? autolinker.link(feature.properties['CodMun'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Num_school'] !== null ? autolinker.link(feature.properties['Num_school'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['total_dem'] !== null ? autolinker.link(feature.properties['total_dem'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['escuela_ma'] !== null ? autolinker.link(feature.properties['escuela_ma'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Area'] !== null ? autolinker.link(feature.properties['Area'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['rural_urba'] !== null ? autolinker.link(feature.properties['rural_urba'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Maya_garif'] !== null ? autolinker.link(feature.properties['Maya_garif'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['no_electri'] !== null ? autolinker.link(feature.properties['no_electri'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['number_no_'] !== null ? autolinker.link(feature.properties['number_no_'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['perc_elec'] !== null ? autolinker.link(feature.properties['perc_elec'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['norm_deman'] !== null ? autolinker.link(feature.properties['norm_deman'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['norm_pobre'] !== null ? autolinker.link(feature.properties['norm_pobre'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['norm_migra'] !== null ? autolinker.link(feature.properties['norm_migra'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['norm_disca'] !== null ? autolinker.link(feature.properties['norm_disca'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['norm_embar'] !== null ? autolinker.link(feature.properties['norm_embar'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['mayor_40'] !== null ? autolinker.link(feature.properties['mayor_40'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Indice'] !== null ? autolinker.link(feature.properties['Indice'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Num_Modulo'] !== null ? autolinker.link(feature.properties['Num_Modulo'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['ObjectID_2'] !== null ? autolinker.link(feature.properties['ObjectID_2'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Ranking'] !== null ? autolinker.link(feature.properties['Ranking'].toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_PoligonosBasico_2_0(feature) {
            if (feature.properties['Indice'] >= 0.000000 && feature.properties['Indice'] <= 0.000000 ) {
                return {
                pane: 'pane_PoligonosBasico_2',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(255,255,255,1.0)',
                interactive: true,
            }
            }
            if (feature.properties['Indice'] >= 0.000000 && feature.properties['Indice'] <= 0.265000 ) {
                return {
                pane: 'pane_PoligonosBasico_2',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(7,186,84,1.0)',
                interactive: true,
            }
            }
            if (feature.properties['Indice'] >= 0.265000 && feature.properties['Indice'] <= 0.352000 ) {
                return {
                pane: 'pane_PoligonosBasico_2',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(253,231,37,1.0)',
                interactive: true,
            }
            }
            if (feature.properties['Indice'] >= 0.352000 && feature.properties['Indice'] <= 0.414627 ) {
                return {
                pane: 'pane_PoligonosBasico_2',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(255,147,45,1.0)',
                interactive: true,
            }
            }
            if (feature.properties['Indice'] >= 0.414627 && feature.properties['Indice'] <= 1.000000 ) {
                return {
                pane: 'pane_PoligonosBasico_2',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(255,4,12,1.0)',
                interactive: true,
            }
            }
        }
        map.createPane('pane_PoligonosBasico_2');
        map.getPane('pane_PoligonosBasico_2').style.zIndex = 402;
        map.getPane('pane_PoligonosBasico_2').style['mix-blend-mode'] = 'normal';
        var layer_PoligonosBasico_2 = new L.geoJson(json_PoligonosBasico_2, {
            attribution: '',
            interactive: true,
            dataVar: 'json_PoligonosBasico_2',
            layerName: 'layer_PoligonosBasico_2',
            pane: 'pane_PoligonosBasico_2',
            onEachFeature: pop_PoligonosBasico_2,
            style: style_PoligonosBasico_2_0,
        });
        bounds_group.addLayer(layer_PoligonosBasico_2);
        map.addLayer(layer_PoligonosBasico_2);
        function pop_Escuelascandidatasprimaria_3(feature, layer) {
            var popupContent = '<table>\
                    <tr>\
                        <th scope="row">Departamen</th>\
                        <td>' + (feature.properties['Departamen'] !== null ? autolinker.link(feature.properties['Departamen'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Municipio</th>\
                        <td>' + (feature.properties['Municipio'] !== null ? autolinker.link(feature.properties['Municipio'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Código</th>\
                        <td>' + (feature.properties['Código'] !== null ? autolinker.link(feature.properties['Código'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Nombre_del</th>\
                        <td>' + (feature.properties['Nombre_del'] !== null ? autolinker.link(feature.properties['Nombre_del'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Dirección</th>\
                        <td>' + (feature.properties['Dirección'] !== null ? autolinker.link(feature.properties['Dirección'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Etnia_pred</th>\
                        <td>' + (feature.properties['Etnia_pred'] !== null ? autolinker.link(feature.properties['Etnia_pred'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Jornada</th>\
                        <td>' + (feature.properties['Jornada'] !== null ? autolinker.link(feature.properties['Jornada'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">estimado_g</th>\
                        <td>' + (feature.properties['estimado_g'] !== null ? autolinker.link(feature.properties['estimado_g'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">OBJECTID_1</th>\
                        <td>' + (feature.properties['OBJECTID_1'] !== null ? autolinker.link(feature.properties['OBJECTID_1'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Posee Electricidad</th>\
                        <td>' + (feature.properties['Posee Electricidad'] !== null ? autolinker.link(feature.properties['Posee Electricidad'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Indice'] !== null ? autolinker.link(feature.properties['Indice'].toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Escuelascandidatasprimaria_3_0(feature) {
            if (feature.properties['Indice'] >= 0.000000 && feature.properties['Indice'] <= 0.000000 ) {
                return {
                pane: 'pane_Escuelascandidatasprimaria_3',
                radius: 4.0,
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(255,255,255,1.0)',
                interactive: true,
            }
            }
            if (feature.properties['Indice'] >= 0.000000 && feature.properties['Indice'] <= 0.265183 ) {
                return {
                pane: 'pane_Escuelascandidatasprimaria_3',
                radius: 4.0,
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(51,160,44,1.0)',
                interactive: true,
            }
            }
            if (feature.properties['Indice'] >= 0.265183 && feature.properties['Indice'] <= 0.351543 ) {
                return {
                pane: 'pane_Escuelascandidatasprimaria_3',
                radius: 4.0,
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(253,231,37,1.0)',
                interactive: true,
            }
            }
            if (feature.properties['Indice'] >= 0.351543 && feature.properties['Indice'] <= 0.414627 ) {
                return {
                pane: 'pane_Escuelascandidatasprimaria_3',
                radius: 4.0,
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(255,147,45,1.0)',
                interactive: true,
            }
            }
            if (feature.properties['Indice'] >= 0.414627 && feature.properties['Indice'] <= 1.000000 ) {
                return {
                pane: 'pane_Escuelascandidatasprimaria_3',
                radius: 4.0,
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(227,26,28,1.0)',
                interactive: true,
            }
            }
        }
        map.createPane('pane_Escuelascandidatasprimaria_3');
        map.getPane('pane_Escuelascandidatasprimaria_3').style.zIndex = 403;
        map.getPane('pane_Escuelascandidatasprimaria_3').style['mix-blend-mode'] = 'normal';
        var layer_Escuelascandidatasprimaria_3 = new L.geoJson(json_Escuelascandidatasprimaria_3, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Escuelascandidatasprimaria_3',
            layerName: 'layer_Escuelascandidatasprimaria_3',
            pane: 'pane_Escuelascandidatasprimaria_3',
            onEachFeature: pop_Escuelascandidatasprimaria_3,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.circleMarker(latlng, style_Escuelascandidatasprimaria_3_0(feature));
            },
        });
        bounds_group.addLayer(layer_Escuelascandidatasprimaria_3);
        map.addLayer(layer_Escuelascandidatasprimaria_3);
        //var baseMaps = {
          //  "OpenStreetMap": layer_OpenStreetMap_0
        //};
      //  var overlayMaps = {
          //  "Custom Tiles": lyr // Treat your tiles as an overlay
       // };

        
                // Title
             //   var title = L.control();
              //  title.onAdd = function(map) {
              //      this._div = L.DomUtil.create('div', 'ctl title');
                //    this.update();
              //      return this._div;
            //    };
             //   title.update = function(props) {
            //        this._div.innerHTML = "bas_cob.tif";
            //    };
             //   title.addTo(map);
        
                // Note

            var osm = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors', minZoom: 6, maxZoom: 13});
            map.addLayer(osm);
            var basemaps = {"OpenStreetMap": osm}
            var overlaymaps = {"Escuelas Candidatas": layer_Escuelascandidatasprimaria_3, "Clúster": layer_PoligonosBasico_2, "Cobertura Básicos": lyr, "Municipios": layer_Municipios_1}     
            L.control.layers(basemaps, overlaymaps, {collapsed: false}).addTo(map);
        //var overlaysTree = [
           // {label: 'Escuelas candidatas primaria<br /><table><tr><td style="text-align: center;"><img src="legend/Escuelascandidatasprimaria_3_00000.png" /></td><td>0.0 - 0.0</td></tr><tr><td style="text-align: center;"><img src="legend/Escuelascandidatasprimaria_3_00001.png" /></td><td>0.0 - 0.0</td></tr><tr><td style="text-align: center;"><img src="legend/Escuelascandidatasprimaria_3_00002.png" /></td><td>0.0 - 0.0</td></tr><tr><td style="text-align: center;"><img src="legend/Escuelascandidatasprimaria_3_00003.png" /></td><td>0.0 - 0.0</td></tr><tr><td style="text-align: center;"><img src="legend/Escuelascandidatasprimaria_3_00004.png" /></td><td>0.0 - 0.0</td></tr></table>', layer: layer_Escuelascandidatasprimaria_3},
          //  {label: 'Poligonos Basico<br /><table><tr><td style="text-align: center;"><img src="legend/PoligonosBasico_2_00000.png" /></td><td>0.0 - 0.0</td></tr><tr><td style="text-align: center;"><img src="legend/PoligonosBasico_2_00001.png" /></td><td>0.0 - 0.0</td></tr><tr><td style="text-align: center;"><img src="legend/PoligonosBasico_2_00002.png" /></td><td>0.0 - 0.0</td></tr><tr><td style="text-align: center;"><img src="legend/PoligonosBasico_2_00003.png" /></td><td>0.0 - 0.0</td></tr><tr><td style="text-align: center;"><img src="legend/PoligonosBasico_2_0414.png" /></td><td>0.4 - 1</td></tr></table>', layer: layer_PoligonosBasico_2},
          //  {label: '<img src="legend/Municipios_1.png" /> Municipios', layer: layer_Municipios_1},
         //   {label: '<img src="legend/Municipios_1.png" /> Coberura Básicos', layer: lyr},
         //   {label: "OpenStreetMap", layer: layer_OpenStreetMap_0},]
       // var lay = L.control.layers.tree(null, overlaysTree,{
            //namedToggle: true,
            //selectorBack: false,
            //closedSymbol: '&#8862; &#x1f5c0;',
            //openedSymbol: '&#8863; &#x1f5c1;',
            //collapseAll: 'Collapse all',
            //expandAll: 'Expand all',
           // collapsed: true,
        //});
       // lay.addTo(map);
        setBounds();
            
               // Priority form submission
                   // Check if the JavaScript is loaded
                //console.log("hola");

            
                document.getElementById('priority-form').addEventListener('submit', function(event) {
                    event.preventDefault();
                
                    // Get values from the form, defaulting to 0 if the field is empty or invalid
                    var demanda = parseFloat(document.getElementById('demanda').value) || 0;
                    var etnicidad = parseFloat(document.getElementById('etnicidad').value) || 0;
                    var pobreza = parseFloat(document.getElementById('pobreza').value) || 0;
                    var migracion = parseFloat(document.getElementById('migracion').value) || 0;
                    var discapacidad = parseFloat(document.getElementById('discapacidad').value) || 0;
                    var embarazos = parseFloat(document.getElementById('embarazos').value) || 0;
                
                    // Get the Demanda Mínima value from user input, defaulting to 40
                    var demandaMinima = parseFloat(document.getElementById('demandaMinima').value) || 40;
                
                    // Check if the sum of inputs is equal to 1
                    var total = demanda + etnicidad + pobreza + migracion + discapacidad + embarazos;
                    var epsilon = 0.0001;  // Small tolerance value

                    if (Math.abs(total - 1) > epsilon) {
                        alert("La suma de los pesos debe ser aproximadamente 1. Corrija los valores.");
                        return;
                    }
                
                    let indexNewValues = [];
                    
                    // Step 1: Calculate 'index_new' for each feature in layer_PoligonosBasico_2
                    layer_PoligonosBasico_2.eachLayer(function(layer) {
                        var feature = layer.feature;
                
                        // Set 'mayor_selected' based on 'demandaMinima'
                        feature.properties['mayor_selected'] = feature.properties['total_dem'] >= demandaMinima ? 1 : 0;
                
                        // Only calculate 'index_new' if 'rural_urba' is 1 and 'mayor_selected' is 1
                        if (feature.properties['rural_urba'] === 1 && feature.properties['mayor_selected'] === 1) {
                            var index_new = 0;
                
                            // Perform weighted calculation using normalized fields
                            index_new += demanda * (feature.properties['norm_deman'] || 0);
                            index_new += etnicidad * (feature.properties['Maya_garif'] || 0);
                            index_new += pobreza * (feature.properties['norm_pobre'] || 0);
                            index_new += migracion * (feature.properties['norm_migra'] || 0);
                            index_new += discapacidad * (feature.properties['norm_disca'] || 0);
                            index_new += embarazos * (feature.properties['norm_embar'] || 0);
                
                            // Store the result in the feature and collect for quartile calculation
                            feature.properties['index_new'] = index_new;
                            indexNewValues.push(index_new);
                        } else {
                            feature.properties['index_new'] = null;  // Set null if conditions are not met
                        }
                    });
                
                    // Step 2: Calculate quartiles
                    const [q1, q2, q3] = calculateQuartiles(indexNewValues);
                    console.log(`Q1: ${q1}, Q2: ${q2}, Q3: ${q3}`);  // Debugging purposes
                
                    // Step 3: Update getColor function to use quartiles
                    function getColor(index_new) {
                        if (index_new === null || index_new === undefined) {
                            return '#FFFFFF';  // White for null/undefined index_new
                        }
                        
                        return index_new === 0 ? '#FFFFFF' :  // White for index_new = 0
                               index_new > q3 ? '#ff040c' :    // 4th quartile (highest values)
                               index_new > q2 ? '#ff932d' :    // 3rd quartile
                               index_new > q1 ? '#fde725' :    // 2nd quartile
                               '#07ba54';                      // 1st quartile (lowest values)
                    }
                
                    // Step 4: Apply the new color scheme to PoligonosBasico layer
                    layer_PoligonosBasico_2.eachLayer(function(layer) {
                        var feature = layer.feature;
                        if (feature.properties['index_new'] !== null) {
                            layer.setStyle({
                                fillColor: getColor(feature.properties['index_new']),
                            });
                        }
                    });
                
                    // Step 5: Transfer 'index_new' values to layer_Escuelascandidatasprimaria_3
                    layer_Escuelascandidatasprimaria_3.eachLayer(function(pointLayer) {
                        var pointFeature = pointLayer.feature;
                
                        // Skip points without OBJECTID_1
                        if (!pointFeature.properties['OBJECTID_1']) {
                            return;
                        }
                
                        // Find the matching polygon by OBJECTID_1 and transfer 'index_new'
                        var foundMatch = false;
                        layer_PoligonosBasico_2.eachLayer(function(polygonLayer) {
                            var polygonFeature = polygonLayer.feature;
                
                            if (pointFeature.properties['OBJECTID_1'] === polygonFeature.properties['OBJECTID_1']) {
                                foundMatch = true;
                
                                // Transfer 'index_new' to the point
                                pointFeature.properties['index_new'] = polygonFeature.properties['index_new'];
                
                                // Apply the color based on the transferred 'index_new' value
                                pointLayer.setStyle({
                                    fillColor: getColor(pointFeature.properties['index_new']),
                                    radius: 6,  // Adjust the radius if needed
                                });
                            }
                        });
                
                        if (!foundMatch) {
                            console.log(`No matching polygon found for Point OBJECTID_1: ${pointFeature.properties['OBJECTID_1']}`);
                        }
                    });
                
                    alert("El índice ha sido calculado y actualizado en ambas capas.");

                    function checkIndexNewValues() {
                        // Find the school with 'Código' 14-16-0678-43 in layer_Escuelascandidatasprimaria_3
                        layer_Escuelascandidatasprimaria_3.eachLayer(function(layer) {
                            var feature = layer.feature;
                            if (feature.properties['Código'] === '14-16-0678-43') {
                                console.log(`School with Código 14-16-0678-43 - OBJECTID_1: ${feature.properties['OBJECTID_1']}, index_new: ${feature.properties['index_new']}`);
                            }
                        });
                    
                        // Find the polygon with ORIG_FID of 2354 in layer_PoligonosBasico_2
                        layer_PoligonosBasico_2.eachLayer(function(layer) {
                            var feature = layer.feature;
                            if (feature.properties['OBJECTID_1'] === 2354) {
                                console.log(`Polygon with OBJECTID_1 2354 - index_new: ${feature.properties['index_new']}`);
                            }
                        });
                    }
                    
                    checkIndexNewValues();



                });
                


                
                // Function to calculate quartiles
                function calculateQuartiles(arr) {
                    arr.sort(function(a, b) { return a - b; });
                
                    const q1 = arr[Math.floor(arr.length * 0.25)];
                    const q2 = arr[Math.floor(arr.length * 0.50)]; // Median
                    const q3 = arr[Math.floor(arr.length * 0.75)];
                
                    return [q1, q2, q3];
                }

          

            //function getColor(index_new) {
               // return index_new > 414627 ? '#ff040c' :
                      // index_new > 0.35 ? '#ff932d' :
                       //index_new > 0.26 ? '#fde725' :
                      // index_new > 0 ? '#07ba54' :
                      // '#FFFFFF';
         //   }

// Extract departamento and municipio data from Municipios_1 layer and populate dropdowns
function populateDepartamentoDropdown() {
    var departamentos = new Set();

    // Collect all departments
    layer_Municipios_1.eachLayer(function(layer) {
        var departamento = layer.feature.properties['departamen'];
        departamentos.add(departamento);
    });

    // Convert the Set to an array and sort alphabetically
    var sortedDepartamentos = Array.from(departamentos).sort();

    // Populate the dropdown with sorted departments
    var departamenSelect = document.getElementById('departamenSelect');
    sortedDepartamentos.forEach(function(departamento) {
        var option = document.createElement('option');
        option.value = departamento;
        option.text = departamento;
        departamenSelect.appendChild(option);
    });
}

// Populate the Municipio Dropdown based on selected Departamento
document.getElementById('departamenSelect').addEventListener('change', function() {
    var selectedDepartamento = this.value;
    var municipioSelect = document.getElementById('municipioSelect');

    // Clear the municipio dropdown
    municipioSelect.innerHTML = '<option value="">Seleccione un Municipio</option>';

    if (!selectedDepartamento) {
        municipioSelect.disabled = true;
        document.getElementById('zoomToMunicipio').disabled = true;
        return;
    }

    municipioSelect.disabled = false;

    // Collect all municipios for the selected department
    var municipios = [];
    layer_Municipios_1.eachLayer(function(layer) {
        var municipio = layer.feature.properties['municipio'];
        var departamento = layer.feature.properties['departamen'];
        var codigo_mun = layer.feature.properties['codigo_mun'];

        if (departamento === selectedDepartamento) {
            municipios.push({ municipio: municipio, codigo_mun: codigo_mun });
        }
    });

    // Sort municipios alphabetically
    municipios.sort(function(a, b) {
        return a.municipio.localeCompare(b.municipio);
    });

    // Populate Municipio dropdown with sorted municipios
    municipios.forEach(function(item) {
        var option = document.createElement('option');
        option.value = item.codigo_mun;  // Use 'codigo_mun' as the value
        option.text = item.municipio;    // Display 'municipio' as the text
        municipioSelect.appendChild(option);
    });
});
// Enable Zoom Button on Municipio selection
document.getElementById('municipioSelect').addEventListener('change', function() {
    document.getElementById('zoomToMunicipio').disabled = this.value === "";
});

// Zoom to selected Municipio
document.getElementById('zoomToMunicipio').addEventListener('click', function() {
    var selectedCodigoMun = document.getElementById('municipioSelect').value;

    if (!selectedCodigoMun) {
        alert('Seleccione un municipio');
        return;
    }

    // Find the matching municipality based on 'codigo_mun'
    layer_Municipios_1.eachLayer(function(layer) {
        var codigo_mun = layer.feature.properties['codigo_mun'];

        if (codigo_mun == selectedCodigoMun) {
            var bounds = layer.getBounds();
            console.log(bounds)
            map.fitBounds(bounds);
        }
    });
});

// Show/hide the advanced filters when the radio button is toggled
document.getElementById('showFilters').addEventListener('change', function() {
    document.getElementById('advancedFilters').style.display = 'block';
});

document.getElementById('hideFilters').addEventListener('change', function() {
    document.getElementById('advancedFilters').style.display = 'none';
});

// Populate departamento dropdown on page load
populateDepartamentoDropdown();






// Global variables to store map layers and current data
let aplicarPressed = false;
let sortedData = [];
let currentPage = 1;
const recordsPerPage = 25;
let objectIdToClusterMap = {};  // Store OBJECTID_1 to Clúster mapping

// Function to update table and map
function updateTable() {
    const start = (currentPage - 1) * recordsPerPage;
    const end = start + recordsPerPage;
    const currentData = sortedData.slice(start, end);

    const tableBody = document.querySelector("#table-section tbody");
    tableBody.innerHTML = "";  // Clear the existing rows

    currentData.forEach((feature, index) => {
        const row = document.createElement("tr");

        // Store OBJECTID_1 in map for future zoom functionality
        objectIdToClusterMap[start + index + 1] = feature.OBJECTID_1;

        // Add the columns with custom names, excluding OBJECTID_1 from the table
        row.innerHTML = `
            <td>${start + index + 1}</td>  <!-- Clúster (ID) -->
            <td>${feature.Departamen || ""}</td>
            <td>${feature.Municipio || ""}</td>
            <td>${feature.Num_school || ""}</td>
            <td>${feature.school1 || ""}</td>
            <td>${feature.school2 || ""}</td>
            <td>${feature.school3 || ""}</td>
            <td>${feature.school4 || ""}</td>
            <td>${feature.school5 || ""}</td>
            <td>${feature.school6 || ""}</td>
            <td>${feature.school7 || ""}</td>
            <td>${feature.school8 || ""}</td>
            <td>${feature.total_dem || ""}</td>
            <td>${feature.Area || ""}</td>
            <td>${feature.perc_elec || ""}</td>
            <td>${feature.Priorizado || ""}</td>
            <td>${aplicarPressed ? (feature.index_new !== undefined && feature.index_new !== null ? feature.index_new : "N/A") 
                                  : (feature.Indice !== undefined && feature.Indice !== null ? feature.Indice : "N/A")}</td> <!-- Índice -->
        `;

        tableBody.appendChild(row);
    });

    // Update pagination controls
    document.getElementById("prevPage").disabled = currentPage === 1;
    document.getElementById("nextPage").disabled = currentPage >= Math.ceil(sortedData.length / recordsPerPage);
}

// Event listener for the "Zoom al Clúster" button
document.getElementById("zoomToClusterBtn").addEventListener("click", function() {
    const clusterNumber = document.getElementById("clusterInput").value;
    const objectId = objectIdToClusterMap[clusterNumber];

    if (objectId !== undefined) {
        // Find the polygon with the matching OBJECTID_1
        layer_PoligonosBasico_2.eachLayer(function(layer) {
            const feature = layer.feature.properties;
            if (feature.OBJECTID_1 === objectId) {
                // Zoom to the polygon
                map.fitBounds(layer.getBounds());
            }
        });
    } else {
        alert("Clúster no encontrado.");
    }
});

// Load initial data from layer_PoligonosBasico_2
function loadInitialData() {
    const data = [];
    layer_PoligonosBasico_2.eachLayer(function(layer) {
        const feature = layer.feature.properties;
        data.push(feature);
    });

    // Sort data based on Indice in descending order and update table
    sortedData = data.sort((a, b) => (b.Indice || 0) - (a.Indice || 0));  // Sort by Indice (largest first)
    updateTable();
}

// Event listener for "Aplicar" button
document.getElementById("priority-form").addEventListener("submit", function(event) {
    event.preventDefault();

    aplicarPressed = true;  // Set flag that Aplicar has been pressed

    // Sort data by index_new when Aplicar is pressed
    sortedData.sort((a, b) => (b.index_new || 0) - (a.index_new || 0));

    currentPage = 1;  // Reset to the first page
    updateTable();  // Update table and store new OBJECTID_1 to Clúster mapping
});

// Load initial data on page load
loadInitialData();

// Descargar a un Excel
document.getElementById('downloadExcel').addEventListener('click', function() {
    // Extract and format data from layer_PoligonosBasico_2
    var data = [];
    
    layer_PoligonosBasico_2.eachLayer(function(layer) {
        var feature = layer.feature.properties;
        
        // Add only the necessary fields with friendly column names
        data.push({
            "Clúster": feature.OBJECTID_1,
            "Departamento": feature.Departamen,
            "Municipio": feature.Municipio,
            "Número de Escuelas": feature.Num_school,
            "Escuela 1": feature.school1,
            "Escuela 2": feature.school2,
            "Escuela 3": feature.school3,
            "Escuela 4": feature.school4,
            "Escuela 5": feature.school5,
            "Escuela 6": feature.school6,
            "Escuela 7": feature.school7,
            "Escuela 8": feature.school8,
            "Total Demanda": feature.total_dem,
            "Área": feature.Area,
            "Porcentaje con Electricidad": feature.perc_elec,
            "Municipio Priorizado": feature.Priorizado,
            "Índice": feature.index_new !== undefined && feature.index_new !== null ? feature.index_new : feature.Indice
        });
    });

    // Sort the data by "Índice" (either index_new or Indice)
    data.sort(function(a, b) {
        return (b["Índice"] || 0) - (a["Índice"] || 0); // Descending order (largest value first)
    });

        // After sorting, update the "Clúster" field to be 1, 2, 3, ... according to the sorted order
    data.forEach(function(item, index) {
        item["Clúster"] = index + 1; // Set Clúster to 1-based sequential index after sorting
    });


    // Convert the data to a worksheet with formatted headers
    var ws = XLSX.utils.json_to_sheet(data, {
        header: [
            "Clúster", "Departamento","Municipio", "Número de Escuelas", "Escuela 1", "Escuela 2", "Escuela 3", 
            "Escuela 4", "Escuela 5", "Escuela 6", "Escuela 7", "Escuela 8",
            "Total Demanda", "Área", "Porcentaje con Electricidad", "Índice"
        ]
    });

    // Adjust column width for better readability
    ws['!cols'] = [
        { wch: 10 }, // Clúster
        { wch: 18 }, // Departamento
        { wch: 18 }, // Municipio
        { wch: 18 }, // Número de Escuelas
        { wch: 15 }, // Escuela 1
        { wch: 15 }, // Escuela 2
        { wch: 15 }, // Escuela 3
        { wch: 15 }, // Escuela 4
        { wch: 15 }, // Escuela 5
        { wch: 15 }, // Escuela 6
        { wch: 15 }, // Escuela 7
        { wch: 15 }, // Escuela 8
        { wch: 20 }, // Total Demanda
        { wch: 10 }, // Área
        { wch: 25 }, // Porcentaje con Electricidad
        { wch: 25 }, // Municipio Priorizado
        { wch: 10 }  // Índice
    ];

    // Create a new workbook and append the worksheet
    var wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Poligonos Candidatos");

    // Export the workbook as an Excel file
    XLSX.writeFile(wb, "Poligonos_Candidatos.xlsx");
});


// Zoom out button functionality
var initialBounds = [[13.68180002055987, -93.39339285963621], [17.964739444007968, -86.88766208984163]];

document.getElementById('zoom-out-button').addEventListener('click', function() {
    map.fitBounds(initialBounds);
});

        </script>
    </body>
</html>
